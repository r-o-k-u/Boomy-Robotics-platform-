<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boomy</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <style>
        :root {
            --primary: #1a2b3c;
            --secondary: #2ecc71;
            --accent: #3498db;
            --danger: #e74c3c;
            --text: #ecf0f1;
            --bg: #121a21;
            --card-bg: rgba(255, 255, 255, 0.05);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            grid-template-rows: auto 1fr;
            gap: 1rem;
            padding: 1rem;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            grid-column: 1 / -1;
        }

        .map-container {
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .telemetry-panel {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
        }

        .video-feed {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: #000; 
            max-height: 480px;
        }

        .telemetry-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .telemetry-card {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 8px;
            transition: transform 0.2s;
        }

        .telemetry-card:hover {
            transform: translateY(-3px);
        }

        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 1rem;
            background: var(--card-bg);
            border-radius: 12px;
            width: 100%;
        }

        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
        }
        .connection-status {
            position: fixed;
            top: 1rem;
            right: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background: rgba(0, 0, 0, 0.3);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #7f8c8d;
        }

        .status-dot.connected {
            background: #2ecc71;
            animation: pulse 1.5s infinite;
        }


        .joystick-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 180px;
        }

        .virtual-joystick {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            position: relative;
            touch-action: none;
        }

        .button-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        button {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        button.danger {
            background: var(--danger);
        }

        button:active {
            transform: scale(0.98);
        }

        @media (max-width: 768px) {
            body {
                grid-template-columns: 1fr;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .drive-indicator {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            padding: 1rem;
            background: var(--card-bg);
            border-radius: 12px;
            margin-top: 30px;
        }

        .wheel-status {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .gps-indicator {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }
        
        .gps-source-serial { background: #2ecc7055; }
        .gps-source-ip_geolocation { background: #3498db55; }
        .gps-source-manual { background: #9b59b655; }
        .gps-source-default { background: #e74c3c55; }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="map-container" id="map"></div>
        <div class="video-feed">
            <img src="/video_feed" alt="Live Feed" class="video-stream">
            <div class="video-overlay">
                <div class="gps-indicator" id="gps-source">GPS: Acquiring...</div>
                <div class="altitude-indicator">ALT: 15.2m</div>
            </div>
        </div>
    </div>

    <div class="telemetry-panel">
        <h2>Flight Telemetry</h2>
        <div class="telemetry-grid" id="telemetry"></div>
        <div class="drive-indicator">
          <div class="wheel-status">
              <div class="wheel" id="front-left-wheel">FL</div>
              <div class="temperature">42¬∞C</div>
          </div>
          <div class="wheel-status">
              <div class="wheel" id="front-right-wheel">FR</div>
              <div class="temperature">40¬∞C</div>
          </div>
          <div class="wheel-status">
              <div class="wheel" id="rear-left-wheel">RL</div>
              <div class="temperature">38¬∞C</div>
          </div>
          <div class="wheel-status">
              <div class="wheel" id="rear-right-wheel">RR</div>
              <div class="temperature">39¬∞C</div>
          </div>
      </div>
    </div>

    <div class="control-panel">
        <div class="button-row">
            <button class="success" onclick="sendCommand('activate')">üîã Power On</button>
            <button onclick="sendCommand('auto_mode')">ü§ñ Auto Mode</button>
            <button class="danger" onclick="sendCommand('emergency_stop')">üõë E-Stop</button>
        </div>
        <!-- Top Row - Joystick -->
        <div class="joystick-container">
            <div class="virtual-joystick" id="joystick"></div>
        </div>
        
        <!-- Bottom Row - Buttons -->
       
    </div>

    <div class="status-bar">
        <div class="connection-status">
            <div class="status-dot" :class="{ connected: isConnected }"></div>
            <span>Connection Status</span>
        </div>
        <div class="gps-status" id="gps-status">
            <span id="gps-coords">üåç 0.0000, 0.0000</span>
        </div>
        <div class="battery-status">üîã 78%</div>
        <div class="signal-status">üì∂ Strong</div>
    </div>


    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        const socket = io();
        let lastUpdate = performance.now();
        const UPDATE_INTERVAL = 50; // ms

        // Initialize map with rover icon
       // Update map initialization
       let roverPosition = [-0.7172, 36.4310]; // Default position
        const map = L.map('map').setView(roverPosition, 17);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const roverIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/947/947680.png',
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });
        const roverMarker = L.marker([-0.702273, 36.426804], {icon: roverIcon}).addTo(map);
        
        // Add GPS accuracy circle
        const accuracyCircle = L.circle(roverPosition, {
            color: '#3498db',
            fillColor: '#3498db30',
            radius: 100
        }).addTo(map);
        

        // Handle GPS updates
        function updatePosition(lat, lon, source) {
            console.log("updating position'",lat, lon, source)
            roverMarker.setLatLng([lat, lon]);
            map.panTo([lat, lon], {animate: true, duration: 0.5});
            
            // Update GPS source indicator
            const sourceNames = {
                serial: 'Rover GPS',
                ip_geolocation: 'Network',
                manual: 'Manual',
                default: 'Default'
            };
            
            const gpsIndicator = document.getElementById('gps-source');
            gpsIndicator.textContent = `üìç ${sourceNames[source]}`;
            gpsIndicator.className = `gps-indicator gps-source-${source}`;
            gpsIndicator.style.animation = 'pulse 1s ease-in-out';
            
            // Update coordinates in status bar
            document.getElementById('gps-coords').textContent = 
                `üåç ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
            
            // Update accuracy circle based on source
            const accuracyRadii = {
                serial: 5,
                ip_geolocation: 500,
                manual: 50,
                default: 1000
            };
            accuracyCircle.setRadius(accuracyRadii[source]);
        }
         // Socket event handlers
         socket.on('gps_update', (data) => {
            updatePosition(data.lat, data.lon, data.source);
        });
        // Differential drive control
        let leftTrackPower = 0;
        let rightTrackPower = 0;

        function updateDriveSystem(x, y) {
            const maxPower = 1.0;
            const turnSensitivity = 0.7;
            
            // Differential drive calculations
            leftTrackPower = Math.min(maxPower, Math.max(-maxPower, y + x * turnSensitivity));
            rightTrackPower = Math.min(maxPower, Math.max(-maxPower, y - x * turnSensitivity));
            
            sendCommand(`drive:${leftTrackPower.toFixed(2)},${rightTrackPower.toFixed(2)}`);
            updateWheelIndicators();
        }

        function updateWheelIndicators() {
            const wheels = {
                'front-left-wheel': leftTrackPower,
                'front-right-wheel': rightTrackPower,
                'rear-left-wheel': leftTrackPower,
                'rear-right-wheel': rightTrackPower
            };

            Object.entries(wheels).forEach(([id, power]) => {
                const wheel = document.getElementById(id);
                wheel.style.color = power > 0 ? '#2ecc71' : '#e74c3c';
                wheel.textContent = `${(Math.abs(power)*100).toFixed(0)}%`;
            });
        }
        // Virtual joystick handling
        const joystick = document.getElementById('joystick');
        let isTouching = false;
        
        joystick.addEventListener('touchstart', handleJoystickStart);
        joystick.addEventListener('touchmove', handleJoystickMove);
        joystick.addEventListener('touchend', handleJoystickEnd);
        
        function handleJoystickStart(e) {
            isTouching = true;
            updateJoystickPosition(e);
        }

        function handleJoystickMove(e) {
            if (isTouching) updateJoystickPosition(e);
        }

        function handleJoystickEnd() {
            isTouching = false;
            joystick.style.transform = 'translate(0, 0)';
        }

        function updateJoystickPosition(e) {
            const rect = joystick.getBoundingClientRect();
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            const touch = e.touches[0];
            const x = touch.clientX - rect.left - centerX;
            const y = touch.clientY - rect.top - centerY;
            
            const distance = Math.sqrt(x*x + y*y);
            const maxDistance = centerX - 20;
            const angle = Math.atan2(y, x);
            
            const limitedX = Math.cos(angle) * Math.min(distance, maxDistance);
            const limitedY = Math.sin(angle) * Math.min(distance, maxDistance);
            
            joystick.style.transform = `translate(${limitedX}px, ${limitedY}px)`;            
            updateDriveSystem(x, -y); // Invert Y axis for intuitive control

        }

        // Optimized telemetry updates
        const telemetryCache = new Map();
        
        function updateTelemetry(data) {
            const now = performance.now();
            if (now - lastUpdate < UPDATE_INTERVAL) return;
            
            Object.entries(data).forEach(([key, value]) => {
                const element = document.getElementById(`telemetry-${key}`);
                if (!element) return;
                
                const formattedValue = Number(value).toFixed(2);
                if (telemetryCache.get(key) !== formattedValue) {
                    element.textContent = formattedValue;
                    element.parentElement.style.animation = 'highlight 0.5s';
                    telemetryCache.set(key, formattedValue);
                }
            });
            
            lastUpdate = now;
        }

        // Command queue with priority system
        const commandQueue = [];
        let isSending = false;
        
        function sendCommand(cmd) {
            const priority = cmd.startsWith('joystick') ? 0 : 1;
            commandQueue.push({ cmd, priority });
            commandQueue.sort((a, b) => a.priority - b.priority);
            
            if (!isSending) processQueue();
        }

        function processQueue() {
            isSending = true;
            while (commandQueue.length > 0) {
                const { cmd } = commandQueue.shift();
                socket.emit('control_command', cmd);
            }
            isSending = false;
        }

        // Socket event handlers
        socket.on('arduino_data', processTelemetryData);
        socket.on('connect', updateConnectionStatus);
        socket.on('disconnect', updateConnectionStatus);

        function processTelemetryData(data) {
            try {
            
                
                // Update other telemetry
                Object.entries(data).forEach(([key, value]) => {
                    const element = document.getElementById(`telemetry-${key}`);
                    if(element) {
                        const formattedValue = Number(value).toFixed(2);
                        if(telemetryCache.get(key) !== formattedValue) {
                            element.textContent = formattedValue;
                            element.parentElement.style.animation = 'highlight 0.5s';
                            telemetryCache.set(key, formattedValue);
                        }
                    }
                });
                
            } catch (error) {
                console.error('Data parsing error:', error);
            }
        }

        function updateConnectionStatus() {
            const statusDot = document.querySelector('.status-dot');
            statusDot.classList.toggle('connected', socket.connected);
        }

        // Initial telemetry setup
        function createTelemetryCards() {
            const container = document.getElementById('telemetry');
            const metrics = [
                'speed', 'voltage', 'current', 'motor_temp',
                'distance', 'bearing', 'cpu_temp', 'signal'
            ];
            
            metrics.forEach(metric => {
                const card = document.createElement('div');
                card.className = 'telemetry-card';
                card.innerHTML = `
                    <div class="metric-name">${metric.toUpperCase()}</div>
                    <div class="metric-value" id="telemetry-${metric}">0.00</div>
                `;
                container.appendChild(card);
            });
        }


        // Handle GPS updates
        function updatePosition(lat, lon) {
            roverMarker.setLatLng([lat, lon]);
            map.panTo([lat, lon]);
        }
        createTelemetryCards();

        // Initialize with default position
        updatePosition(...roverPosition, 'default');
         
    </script>
</body>
</html>