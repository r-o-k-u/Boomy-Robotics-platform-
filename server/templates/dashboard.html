<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boomy</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        :root {
            --primary: #1a2b3c;
            --secondary: #2ecc71;
            --accent: #3498db;
            --danger: #e74c3c;
            --text: #ecf0f1;
            --bg: #121a21;
            --card-bg: rgba(255, 255, 255, 0.05);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            grid-template-rows: auto 1fr auto;
            gap: 1rem;
            padding: 1rem;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            grid-column: 1 / -1;
        }

        .map-container {
            height: 500px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .telemetry-panel {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .video-feed {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            max-height: 480px;
            aspect-ratio: 16/9;
        }

        .telemetry-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .telemetry-card {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 8px;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .telemetry-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--secondary);
            opacity: 0;
            transition: var(--transition);
        }

        .telemetry-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .telemetry-card:hover::after {
            opacity: 1;
        }

        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 1.5rem;
            background: var(--card-bg);
            border-radius: 12px;
            width: 100%;
        }

        .status-bar {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            padding: 0.75rem 1.5rem;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            backdrop-filter: blur(5px);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #7f8c8d;
            transition: var(--transition);
        }

        .status-dot.connected {
            background: #2ecc71;
            box-shadow: 0 0 8px #2ecc71;
        }

        .joystick-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
        }

        .virtual-joystick {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            position: relative;
            touch-action: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .button-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        button {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            font-size: 1rem;
            font-weight: 500;
        }

        button:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }

        button:active {
            transform: scale(0.98);
        }

        .drive-indicator {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            padding: 1rem;
            background: var(--card-bg);
            border-radius: 12px;
            margin-top: 1.5rem;
        }

        .map-overlay {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .video-overlay {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .telemetry-sparkline {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            opacity: 0.3;
            transition: var(--transition);
        }

        .telemetry-card:hover .telemetry-sparkline {
            opacity: 0.7;
        }

        @media (max-width: 768px) {
            body {
                grid-template-columns: 1fr;
                padding: 0.5rem;
            }

            .status-bar {
                flex-wrap: wrap;
                gap: 0.5rem;
            }
        }

        .context-menu {
            position: fixed;
            background: var(--card-bg);
            border-radius: 8px;
            padding: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
        }

        .waypoint-marker {
            filter: hue-rotate(120deg);
        }

        /* Receiver Channels Styling */
        .channels-container {
            display: grid;
            gap: 12px;
        }

        .channel-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .channel-label {
            font-weight: 500;
            width: 60px;
        }

        .channel-progress {
            flex-grow: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        progress {
            width: 100%;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
        }

        progress::-webkit-progress-value {
            background-color: #4CAF50;
            transition: width 0.3s ease;
        }

        .digital-indicator {
            padding: 4px 12px;
            border-radius: 15px;
            background: #eee;
            font-weight: bold;
        }

        .digital-indicator.active {
            background: #4CAF50;
            color: white;
        }

        .transmitter-panel {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .channel-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .channel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 0.5rem;
            text-align: center;
        }

        .analog-bar {
            height: 100px;
            width: 20px;
            background: #333;
            border-radius: 4px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
        }

        .analog-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: var(--secondary);
            transition: height 0.3s ease;
        }

        .digital-led {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #444;
            margin: 0 auto;
            transition: background 0.2s ease;
        }

        .digital-led.active {
            background: var(--secondary);
            box-shadow: 0 0 8px var(--secondary);
        }

        /* added */
        .channel {
            margin: 0.5rem;
            padding: 0.5rem;
            border: 1px solid #444;
            border-radius: 4px;
        }

        /* .analog-bar {
            height: 20px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
        } */

        .analog-fill {
            height: 100%;
            background: #3498db;
            transition: width 0.2s ease;
        }

        .digital-led {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #e74c3c;
            transition: background 0.2s ease;
        }

        .digital-led.active {
            background: #2ecc71;
        }

        .switch-state {
            display: flex;
            justify-content: space-between;
            padding: 0.2rem 0;
        }

        .switch-state.active {
            color: #2ecc71;
        }

        .switch-state.inactive {
            color: #e74c3c;
        }

        .channel-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            padding: 1rem;
        }

        .channel {
            background: #2c3e50;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        /* .analog-bar {
            height: 20px;
            background: #34495e;
            border-radius: 4px;
            margin: 0.5rem 0;
            overflow: hidden;
        } */

        .analog-fill {
            height: 100%;
            background: #3498db;
            transition: width 0.3s ease;
        }

        .digital-led {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e74c3c;
            margin: 0 auto;
            transition: background 0.3s ease;
        }

        .digital-led.active {
            background: #2ecc71;
        }

        #gps-coords {
            font-family: monospace;
            font-size: 0.9rem;
            color: #2ecc71;
            margin: 0 1rem;
        }

        .gps-indicator {
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.3);
        }

        .gps-source-serial {
            color: #2ecc71;
        }

        .gps-source-ip_geolocation {
            color: #f1c40f;
        }

        .gps-source-manual {
            color: #9b59b6;
        }

        .threed-view {
            position: relative;
            border: 2px solid #34495e;
            border-radius: 8px;
            overflow: hidden;
            margin-left: 1rem;
            background: #2c3e50;
        }
    </style>
</head>

<body>
    <div class="dashboard">
        <div class="map-container" id="map"></div>
        <div id="rover-3d-view" style="width: 400px; height: 300px;"></div>

        <div class="map-overlay">
            <div>GPS Accuracy: <span id="gps-accuracy">0m</span></div>
            <div>Satellites: <span id="gps-satellites">0</span></div>
            <button onclick="clearPath()" style="margin-top: 0.5rem;">üßπ Clear Path</button>
        </div>
        <div class="video-feed">
            <img src="/video_feed" alt="Live Feed" class="video-stream">
            <div class="video-overlay">
                <div class="gps-indicator" id="gps-source">GPS: Acquiring...</div>
                <div class="altitude-indicator">ALT: 15.2m</div>
            </div>
        </div>
        <div class="transmitter-panel">
            <h3>Receiver Channels</h3>
            <div class="channel-container" id="channels-display"></div>
        </div>
    </div>

    <div class="telemetry-panel">
        <h2>Flight Telemetry</h2>
        <div class="telemetry-grid" id="telemetry">
            <div class="telemetry-item"><strong>Time:</strong> <span id="telemetry-timestamp">0</span> ms</div>
            <div class="telemetry-item"><strong>Raw Channels:</strong>
                <ul id="telemetry-raw" class="telemetry-list"></ul>
            </div>
            <div class="telemetry-item"><strong>Switches:</strong>
                <ul id="telemetry-switch" class="telemetry-list"></ul>
            </div>
            <div class="telemetry-item"><strong>Lights:</strong> <span id="indicator-lights"
                    class="indicator off"></span></div>
            <div class="telemetry-item"><strong>E-Stop:</strong> <span id="indicator-estop"
                    class="indicator off"></span></div>
            <div class="telemetry-item"><strong>Brakes:</strong> <span id="indicator-brake"
                    class="indicator off"></span></div>
            <div class="telemetry-item"><strong>Motor 1:</strong>
                <div class="motor-bar">
                    <div id="motor-1-bar" class="fill"></div>
                </div>
                <span id="motor-1-value">0</span>
            </div>
            <div class="telemetry-item"><strong>Motor 2:</strong>
                <div class="motor-bar">
                    <div id="motor-2-bar" class="fill"></div>
                </div>
                <span id="motor-2-value">0</span>
            </div>
            <div class="telemetry-item"><strong>Status:</strong> <span id="status-text">IDLE</span></div>
        </div>

        <!-- <div class="drive-indicator">
            <div class="wheel-status">
                <div class="wheel" id="front-left-wheel">FL</div>
                <div class="temperature" id="temp-fl">42¬∞C</div>
            </div>
            <div class="wheel-status">
                <div class="wheel" id="front-right-wheel">FR</div>
                <div class="temperature" id="temp-fr">40¬∞C</div>
            </div>
            <div class="wheel-status">
                <div class="wheel" id="rear-left-wheel">RL</div>
                <div class="temperature" id="temp-rl">38¬∞C</div>
            </div>
            <div class="wheel-status">
                <div class="wheel" id="rear-right-wheel">RR</div>
                <div class="temperature" id="temp-rr">39¬∞C</div>
            </div>
        </div> -->
    </div>

    <div class="control-panel">
        <div class="button-row">
            <button class="success" onclick="sendCommand('activate')">üîã Power On</button>
            <button onclick="sendCommand('auto_mode')">ü§ñ Auto Mode</button>
            <button class="danger" onclick="sendCommand('emergency_stop')">üõë E-Stop</button>
        </div>
        <!-- Top Row - Joystick -->
        <div class="joystick-container">
            <div class="virtual-joystick" id="joystick"></div>
        </div>

        <!-- Bottom Row - Buttons -->

    </div>

    <div class="status-bar">
        <div class="connection-status">
            <div class="status-dot connected"></div>
            <span id="connection-text">Connected</span>
        </div>
        <div id="gps-coords">üåç 0.0000, 0.0000</div>
        <div class="battery-status">üîã <span id="battery-level">78%</span></div>
        <div class="signal-status">üì∂ <span id="signal-strength">Strong</span></div>
        <button onclick="toggleTheme()" style="padding: 0.25rem 0.75rem;">üåì Theme</button>
    </div>


    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Configuration Constants
        const CONFIG = {
            UPDATE_INTERVAL: 5,          // Joystick update interval (ms)
            JOYSTICK_HISTORY_MAX: 50,    // Trail points to keep
            MAX_MOTOR_POWER: 1.0,        // Maximum motor power (100%)
            GPS_ACCURACY: {              // GPS accuracy radii in meters
                serial: 5,
                ip_geolocation: 500,
                manual: 50,
                default: 1000
            },
            CHANNEL_CONFIG: {           // Channel type definitions
                ANALOG: [1, 2, 3, 4, 9, 10],
                DIGITAL: [5, 6, 7, 8]
            }
        };


        // 3D Visualization System
        const Rover3D = {
            scene: null,
            camera: null,
            renderer: null,
            rover: null,
            ready: false,

            init(containerId) {
                // Scene setup
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, 400 / 300, 0.1, 1000);
                this.renderer = new THREE.WebGLRenderer({ antialias: true });


                // Lighting
                const ambientLight = new THREE.AmbientLight(0x404040);
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
                directionalLight.position.set(1, 1, 1);
                this.scene.add(ambientLight, directionalLight);

                // Create rover model
                this.createRoverModel();

                // Camera position
                this.camera.position.set(2, 2, 2);
                this.camera.lookAt(0, 0, 0);

                // Add to DOM
                const container = document.getElementById(containerId);
                this.renderer.setSize(400, 300);
                container.appendChild(this.renderer.domElement);

                // Start animation loop
                this.animate();
                this.ready = true;
            },

            createRoverModel() {
                const roverGroup = new THREE.Group();

                // Main body
                const bodyGeometry = new THREE.BoxGeometry(1, 0.4, 0.5);
                const bodyMaterial = new THREE.MeshPhongMaterial({ color: 0x2ecc71 });
                const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
                body.position.y = 0.2;

                // Wheels
                const wheelGeometry = new THREE.CylinderGeometry(0.15, 0.15, 0.1, 32);
                const wheelMaterial = new THREE.MeshPhongMaterial({ color: 0x34495e });

                const wheels = [];
                for (let i = 0; i < 2; i++) {
                    const wheel = new THREE.Mesh(wheelGeometry, wheelMaterial);
                    wheel.rotation.z = Math.PI / 2;
                    wheel.position.x = i === 0 ? -0.6 : 0.6;
                    wheel.position.y = 0.1;
                    wheels.push(wheel);
                }

                roverGroup.add(body, ...wheels);
                this.rover = roverGroup;
                this.scene.add(roverGroup);
            },

            updateOrientation(roll, pitch) {
                if (!this.ready || !this.rover) return;

                // Convert degrees to radians
                this.rover.rotation.z = THREE.MathUtils.degToRad(roll);
                this.rover.rotation.x = THREE.MathUtils.degToRad(pitch);
            },

            updatePosition(accel) {
                if (!this.ready || !this.rover || !this.rover.position) {
                    console.warn("Rover model not initialized yet.");
                    return; // Exit silently if not ready
                }

                this.rover.position.x += accel.x * 0.01;
                this.rover.position.y += accel.y * 0.01;
                this.rover.position.z += accel.z * 0.01;
            },

            animate() {
                requestAnimationFrame(() => this.animate());
                this.renderer.render(this.scene, this.camera);
            }
        };

        // Core Application Instance
        const RoverControl = {
            // System State
            state: {
                connection: {
                    connected: false,
                    latency: []
                },
                position: {
                    current: [-0.702273, 36.426804],  // Default position
                    accuracy: 100,
                    source: 'default'
                },
                drive: {
                    leftPower: 0,
                    rightPower: 0
                },
                telemetry: new Map(),
                commandQueue: [],
                isSending: false
            },

            // System Components
            components: {
                map: null,
                roverMarker: null,
                accuracyCircle: null,
                waypoints: [],
                joystickHistory: []
            },

            // UI Elements Cache
            ui: {
                indicators: {},
                telemetryDisplays: {},
                channelElements: {}
            },

            // Initialization Methods
            init() {
                console.log("initializing ....")
                Rover3D.init('rover-3d-view');
                this.initMap();
                this.initSocket();
                this.initUI();
                this.initEventListeners();
                this.startMonitoring();
                this.ui.indicators = {
                    lights: document.getElementById('indicator-lights') || console.error('Lights indicator not found'),
                    estop: document.getElementById('indicator-estop') || console.error('E-Stop indicator not found'),
                    brake: document.getElementById('indicator-brake') || console.error('Brake indicator not found'),
                    gpsSource: document.getElementById('gps-source') || console.error('GPS source indicator not found'),
                    gpsCoords: document.getElementById('gps-coords') || console.error('GPS coordinates display not found')
                };
                if (!this.ui.indicators.gpsCoords) {
                    console.error('GPS coordinates display element not found!');
                    // Create fallback element if missing
                    const fallback = document.createElement('div');
                    fallback.id = 'gps-coords';
                    document.querySelector('.status-bar').appendChild(fallback);
                    this.ui.indicators.gpsCoords = fallback;
                }
                
            },

            // Map Initialization
            initMap() {
                // Create base map
                this.components.map = L.map('map').setView(
                    this.state.position.current,
                    17
                );

                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
                    .addTo(this.components.map);

                // Create rover marker
                const roverIcon = L.icon({
                    iconUrl: 'https://cdn-icons-png.flaticon.com/512/947/947680.png',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });

                this.components.roverMarker = L.marker(
                    this.state.position.current,
                    { icon: roverIcon }
                ).addTo(this.components.map);

                // Initialize accuracy circle
                this.components.accuracyCircle = L.circle(
                    this.state.position.current, {
                    color: '#3498db',
                    fillColor: '#3498db30',
                    radius: this.state.position.accuracy
                }).addTo(this.components.map);

                // Configure map controls
                L.control.scale({ imperial: false }).addTo(this.components.map);
            },

            // WebSocket Initialization
            initSocket() {
                this.socket = io();
                this.registerSocketHandlers();
            },

            // UI Initialization
            initUI() {
                // Cache DOM elements
                this.ui.indicators = {
                    lights: document.getElementById('indicator-lights'),
                    estop: document.getElementById('indicator-estop'),
                    brake: document.getElementById('indicator-brake'),
                    gpsSource: document.getElementById('gps-source'),
                    gpsCoords: document.getElementById('gps-coords')
                };

                // Initialize telemetry displays
                this.createTelemetryCards();
                this.createChannelDisplay();

                // Initialize joystick canvas
                this.joystickCanvas = document.getElementById('joystick-canvas');
                this.joystickContext = this.joystickCanvas.getContext('2d');
            },

            // Event Listeners
            initEventListeners() {
                // Map interactions
                this.components.map.on('contextmenu', this.handleMapRightClick.bind(this));

                // Joystick controls
                const joystick = document.getElementById('joystick');
                joystick.addEventListener('touchstart', this.handleJoystickStart.bind(this));
                joystick.addEventListener('touchmove', this.handleJoystickMove.bind(this));
                joystick.addEventListener('touchend', this.handleJoystickEnd.bind(this));

                // Keyboard controls
                document.addEventListener('keydown', this.handleKeyboardShortcuts.bind(this));
            },

            // Socket Event Handlers
            registerSocketHandlers() {
                // Connection status
                this.socket.on('connect', () => this.updateConnectionStatus(true));
                this.socket.on('disconnect', () => this.updateConnectionStatus(false));

                // Data updates
                this.socket.on('gps_update', this.handleGPSUpdate.bind(this));
                this.socket.on('receiver_channels', this.handleChannelData.bind(this));


                this.socket.on('telemetry', this.handleTelemetryUpdate.bind(this));
            },

            // GPS Handling
            handleGPSUpdate(data) {
                this.validatePosition(data);
                this.updatePositionDisplay(data);
                this.updateMapElements(data);
            },

            validatePosition({ lat, lon }) {
                if (isNaN(lat)) throw new Error(`Invalid latitude: ${lat}`);
                if (isNaN(lon)) throw new Error(`Invalid longitude: ${lon}`);
            },

            updatePositionDisplay({ lat, lon, source }) {
                // Safe coordinate update
                try {
                    if (this.ui.indicators.gpsCoords) {
                        this.ui.indicators.gpsCoords.textContent =
                            `üåç ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                    }
                } catch (error) {
                    console.error('Failed to update GPS display:', error);
                }

                // Update source indicator with null check
                if (this.ui.indicators.gpsSource) {
                    const sourceNames = {
                        serial: 'Rover GPS',
                        ip_geolocation: 'Network',
                        manual: 'Manual',
                        default: 'Default'
                    };
                    this.ui.indicators.gpsSource.textContent = `üìç ${sourceNames[source]}`;
                    this.ui.indicators.gpsSource.className = `gps-source-${source}`;
                }
            },
            updateMapElements({ lat, lon, source }) {
                // Update marker position
                this.components.roverMarker.setLatLng([lat, lon]);
                this.components.map.panTo([lat, lon], { animate: true, duration: 0.5 });

                // Update accuracy circle
                const accuracy = CONFIG.GPS_ACCURACY[source] || 1000;
                this.components.accuracyCircle.setRadius(accuracy);
            },

            createChannelDisplay() {
                const container = document.getElementById('channels-display');
                if (!container) {
                    console.error('Channel container not found');
                    return;
                }
                container.innerHTML = '';

                // Create all 10 channels dynamically
                for (let channel = 1; channel <= 10; channel++) {
                    const isAnalog = CONFIG.CHANNEL_CONFIG.ANALOG.includes(channel);

                    const channelDiv = document.createElement('div');
                    channelDiv.className = `channel ${isAnalog ? 'analog' : 'digital'}`;
                    channelDiv.innerHTML = `
            <div class="channel-label">CH${channel}</div>
            ${isAnalog ? `
                <div class="analog-bar">
                    <div class="analog-fill" id="channel-${channel}"></div>
                </div>
                <div class="channel-value">0%</div>
            ` : `
                <div class="digital-led" id="channel-${channel}"></div>
                <div class="channel-state">OFF</div>
            `}
        `;

                    container.appendChild(channelDiv);
                }
            },

            // Channel Data Handling
            handleChannelData(data) {
                try {
                    if (!data) {
                        console.error('Received empty channel data');
                        return;
                    }

                    // Validate data structure
                    if (data.ch_raw) this.updateRawChannels(data.ch_raw);
                    if (data.sw) this.updateSwitchStates(data.sw);
                    if (data.lights !== undefined && data.estop !== undefined && data.brakes !== undefined) {
                        this.updateSystemIndicators(data);
                    }
                    if (data.motors) this.updateMotorDisplays(data.motors);
                    if (data.orientation) {
                        Rover3D.updateOrientation(
                            data.orientation.roll,
                            data.orientation.pitch
                        );
                    }
                    // if (data.accel) {
                    //     Rover3D.updatePosition(data.accel);
                    // }
                } catch (error) {
                    console.error('Error processing channel data:', error);
                }
            },

            updateSystemIndicators({ lights, estop, brakes }) {
                const updateIndicator = (element, state, activeText, inactiveText) => {
                    if (!element) return;
                    element.classList.toggle('on', state);
                    element.textContent = state ? activeText : inactiveText;
                };

                updateIndicator(this.ui.indicators.lights, lights, 'LIGHTS ON', 'LIGHTS OFF');
                updateIndicator(this.ui.indicators.estop, estop, 'ESTOP ACTIVE', 'ESTOP CLEAR');
                updateIndicator(this.ui.indicators.brake, brakes, 'BRAKE ENGAGED', 'BRAKE RELEASED');
            },

            // Motor Control Logic
            calculateMotorPowers(x, y) {
                const turnSensitivity = 0.7;
                const clamp = (v) => Math.min(CONFIG.MAX_MOTOR_POWER,
                    Math.max(-CONFIG.MAX_MOTOR_POWER, v));

                return {
                    left: clamp(y + x * turnSensitivity),
                    right: clamp(y - x * turnSensitivity)
                };
            },

            // Command Queue Management
            sendCommand(command) {
                const priority = command.startsWith('joystick') ? 0 : 1;
                this.state.commandQueue.push({ command, priority });
                this.state.commandQueue.sort((a, b) => a.priority - b.priority);

                if (!this.state.isSending) this.processCommandQueue();
            },

            processCommandQueue() {
                this.state.isSending = true;
                while (this.state.commandQueue.length > 0) {
                    const { command } = this.state.commandQueue.shift();
                    this.socket.emit('control_command', command);
                }
                this.state.isSending = false;
            },

            // Additional methods for UI updates, telemetry handling, 
            // and event processing would follow similar patterns...

            updateConnectionStatus() {
                const statusDot = document.querySelector('.status-dot');
                statusDot.classList.toggle('connected', this.socket.connected);
            },

            updateRawChannels(chArray) {
                // console.log('Updating raw channels:', chArray);
                chArray.forEach(obj => {
                    const [key, value] = Object.entries(obj)[0];
                    const channelNumber = parseInt(key.replace('ch', ''), 10);

                    // Validate channel number
                    if (isNaN(channelNumber) || channelNumber < 1 || channelNumber > 10) {
                        console.error('Invalid channel number:', key);
                        return;
                    }

                    const element = document.getElementById(`channel-${channelNumber}`);
                    if (!element) {
                        console.warn(`Channel element ${channelNumber} not found - recreating display`);
                        this.createChannelDisplay();
                        return;
                    }
                    // Find parent channel container
                    const channelContainer = element.closest('.channel');
                    if (!channelContainer) {
                        console.error('Channel container not found for element');
                        return;
                    }

                    const valueDisplay = channelContainer.querySelector('.channel-value, .channel-state');

                    if (channelNumber <= 4 || channelNumber >= 9) {
                        // Analog channel handling
                        const percent = Math.min(100, Math.max(0, ((value + 100) / 200 * 100)));
                        element.style.height = `${percent.toFixed(0)}%`;
                        if (valueDisplay) {
                            valueDisplay.textContent = `${percent.toFixed(0)}%`;
                        }
                    } else {
                        // Digital channel handling
                        const isActive = value > 0;
                        element.classList.toggle('active', isActive);
                        if (valueDisplay) {
                            valueDisplay.textContent = isActive ? 'ON' : 'OFF';
                        }
                    }
                });
            },
            updateSwitchStates(switchStates) {
                try {
                    const list = document.getElementById('telemetry-switch');
                    if (!list) {
                        console.error('Switch states container not found');
                        return;
                    }

                    // Clear existing items safely
                    while (list.firstChild) {
                        list.removeChild(list.firstChild);
                    }

                    // Create new list items with error checking
                    if (Array.isArray(switchStates)) {
                        switchStates.forEach((state, index) => {
                            const channelNumber = index + 5;
                            const listItem = document.createElement('li');
                            listItem.className = `switch-state ${state ? 'active' : 'inactive'}`;
                            listItem.innerHTML = `
                                <span class="channel-number">CH${channelNumber}</span>
                                <span class="switch-status">${state ? 'ON' : 'OFF'}</span>
                            `;
                            list.appendChild(listItem);
                        });
                    }
                } catch (error) {
                    console.error('Error updating switch states:', error);
                }
            },

            updateMotorDisplays(motorSpeeds) {
                try {
                    if (!Array.isArray(motorSpeeds) || motorSpeeds.length < 2) {
                        console.error('Invalid motor data:', motorSpeeds);
                        return;
                    }

                    const updateMotor = (motorId, speed) => {
                        const bar = document.getElementById(`motor-${motorId}-bar`);
                        const value = document.getElementById(`motor-${motorId}-value`);

                        if (bar && value) {
                            const percentage = this.mapSpeedToPercent(speed);
                            bar.style.width = `${percentage}%`;
                            value.textContent = `${Math.abs(speed)}`;
                            value.style.color = speed > 0 ? '#2ecc71' : '#e74c3c';
                        }
                    };

                    updateMotor(1, motorSpeeds[0]);
                    updateMotor(2, motorSpeeds[1]);
                } catch (error) {
                    console.error('Error updating motor displays:', error);
                }
            },

            mapSpeedToPercent(speed) {
                return Math.round(
                    (Math.min(255, Math.max(-255, speed) + 255) / 510 * 100
                    ))
            },
            // Initialization
            startMonitoring() {
                setInterval(this.monitorConnection.bind(this), 5000);
            }
        };


        document.addEventListener('DOMContentLoaded', () => {
            RoverControl.init();
        });
    </script>
</body>

</html>